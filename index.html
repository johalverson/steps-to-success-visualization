<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steps to Success Visualization (Printable)</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Define the font family for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        /* Custom styles for the D3 chart cells */
        .coverage-cell {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border-radius: 4px;
        }
        .coverage-cell:hover {
            opacity: 0.9;
        }

        /* Tooltip styling */
        #tooltip {
            position: absolute;
            text-align: left;
            padding: 10px;
            font-size: 12px;
            background: #2d3748; /* Dark background */
            color: #f7fafc; /* Light text */
            border: 0px;
            border-radius: 6px;
            pointer-events: none;
            visibility: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* Update: Ensure X-axis labels are readable */
        .x-axis text {
            font-size: 14px; /* Larger size */
            font-weight: 600; /* Bolder */
        }

        /* --- PRINT STYLES --- */
        @media print {
            /* Hide non-essential elements when printing */
            .print-hidden {
                display: none !important;
            }
            /* Reset background for better printing */
            body, .container {
                background-color: white !important;
            }
            /* Adjust SVG container to fit standard paper width */
            #chart-container {
                width: 100%;
                /* Remove margin around chart */
                padding: 0;
            }
            /* Ensure the SVG scales up/down nicely on the page */
            #timeline-chart {
                /* Let the browser handle the scaling */
                max-width: 100%;
                height: auto !important; 
            }
            /* Ensure Y-axis labels are readable */
            .y-axis text {
                font-size: 9px; 
            }
             /* Add print size for X-axis */
            .x-axis text {
                font-size: 10px;
            }
        }
    </style>
</head>
<body class="p-6">

    <div class="max-w-4xl mx-auto container">
        
        <!-- === LOGO SECTION === -->
        <div class="flex flex-col items-center w-full mb-6">
            <img id="school-logo" 
                 src="https://cmsv2-assets.apptegy.net/uploads/15748/logo/16725/Rocherster_district_logo_web.png" 
                 alt="School District Logo" 
                 class="h-16 w-auto mb-4 print-hidden"> 
            
            <h1 class="text-3xl font-extrabold text-gray-800">Steps to Success Visualization</h1>
        </div>
        <!-- === END LOGO SECTION === -->

        
        <!-- UI Container (Hidden during Print) -->
        <div class="print-hidden flex flex-col items-start mb-6 p-4 bg-white rounded-lg shadow-md">
            
            <h2 class="text-xl font-semibold text-gray-800 mb-4 w-full">Data Source Configuration</h2>

            <!-- URL Inputs and Load Button -->
            <div class="w-full space-y-4 mb-4">
                
                <!-- Input Group 1: Program Coverage (X-Axis/Cells) + Load Button -->
                <div>
                    <label for="programUrlInput" class="block text-sm font-medium text-gray-700 mb-1">1. Program Coverage Data (X-Axis/Cells)</label>
                    <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-3 sm:space-y-0">
                        <input type="text" id="programUrlInput" 
                            placeholder="Paste the link from 'Publish to the web' for Sheet 2" 
                            class="flex-1 p-2 border border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500" 
                            value="">
                        
                        <button id="loadDataButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-150 ease-in-out whitespace-nowrap">
                            Load Data
                        </button>
                    </div>
                </div>

                <div id="statusMessage" class="text-sm text-red-600 font-semibold mt-2"></div>
            </div>


            <div class="flex justify-between w-full items-center">
                <!-- Category Selector -->
                <div class="flex items-center space-x-3 mb-2 sm:mb-0">
                    <label for="categorySelector" class="text-gray-600 font-medium">Group by:</label>
                    <select id="categorySelector" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                </div>

                <!-- Print Button (Triggers window.print()) -->
                <button onclick="window.print()" class="print-button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-150 ease-in-out flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm12 0h-4v3h4V4zM4 12v3h14v-3H4z" clip-rule="evenodd" />
                    </svg>
                    <span>Print to PDF</span>
                </button>
            </div>
        </div>

        <!-- Chart Container -->
        <div id="chart-container" class="bg-white p-4 rounded-lg shadow-lg overflow-x-auto">
            <svg id="timeline-chart"></svg>
        </div>
        
        <!-- Legend/Key -->
        <div class="mt-8 p-4 bg-white rounded-lg shadow-md print-hidden">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">Legend</h3>
            <div class="flex space-x-6">
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 rounded-sm" style="background-color: #3498db;"></div>
                    <span class="text-sm text-gray-600">Coverage (1 Program)</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 rounded-sm" style="background-color: #c0392b;"></div>
                    <span class="text-sm text-gray-600">Overlap (2+ Programs)</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 rounded-sm bg-gray-200 border border-gray-400"></div>
                    <span class="text-sm text-gray-600">No Coverage (0 Programs)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip Element -->
    <div id="tooltip" class="rounded-lg shadow-xl"></div>


    <!-- JavaScript (D3 Logic) -->
    <script>
        // Dimensions and Setup
        const margin = {top: 50, right: 20, bottom: 20, left: 100};
        const initialWidth = 700 - margin.left - margin.right; // Base width for initial centering
        const MIN_CATEGORY_WIDTH = 100; // Define minimum width for each category column
        let currentChartWidth = initialWidth; // Variable to hold the dynamically calculated width

        // Initializing SVG container
        const svgContainer = d3.select("#timeline-chart");
        let svg = svgContainer.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const tooltip = d3.select("#tooltip");
        // These keys must match the headers in your Sheet 2
        const categoryOptions = ["Rigor", "Program_Type"]; 
        let yScale; 
        let allFrameworkData; 
        
        // --- HARDCODED FRAMEWORK DATA (Sheet 1 / Y-Axis) ---
        const hardcodedFrameworkData = [
            { ID: 'G-01', Name: 'Step 1', Grade: 'K' },
            { ID: 'G-02', Name: 'Step 2', Grade: 'K' },
            { ID: 'G-03', Name: 'Step 3', Grade: '1' },
            { ID: 'G-04', Name: 'Step 4', Grade: '1' },
            { ID: 'G-05', Name: 'Step 5', Grade: '1' },
            { ID: 'G-06', Name: 'Step 6', Grade: '2' },
            { ID: 'G-07', Name: 'Step 7', Grade: '2' },
            { ID: 'G-08', Name: 'Step 8', Grade: '2' },
            { ID: 'G-09', Name: 'Step 9', Grade: '3' },
            { ID: 'G-10', Name: 'Step 10', Grade: '3' },
            { ID: 'G-11', Name: 'Step 11', Grade: '3' },
            { ID: 'G-12', Name: 'Step 12', Grade: '4' },
            { ID: 'G-13', Name: 'Step 13', Grade: '4' },
            { ID: 'G-14', Name: 'Step 14', Grade: '4' },
            { ID: 'G-15', Name: 'Step 15', Grade: '5' },
            { ID: 'G-16', Name: 'Step 16', Grade: '5' },
            { ID: 'G-17', Name: 'Step 17', Grade: '5' },
            { ID: 'G-18', Name: 'Step 18', Grade: '6' },
            { ID: 'G-19', Name: 'Step 19', Grade: '6' },
            { ID: 'G-20', Name: 'Step 20', Grade: '6' },
            { ID: 'G-21', Name: 'Step 21', Grade: '7' },
            { ID: 'G-22', Name: 'Step 22', Grade: '7' },
            { ID: 'G-23', Name: 'Step 23', Grade: '7' },
            { ID: 'G-24', Name: 'Step 24', Grade: '8' },
            { ID: 'G-25', Name: 'Step 25', Grade: '8' },
            { ID: 'G-26', Name: 'Step 26', Grade: '8' },
            { ID: 'G-27', Name: 'Step 27', Grade: '9' },
            { ID: 'G-28', Name: 'Step 28', Grade: '9' },
            { ID: 'G-29', Name: 'Step 29', Grade: '9' },
            { ID: 'G-30', Name: 'Step 30', Grade: '9' },
            { ID: 'G-31', Name: 'Step 31', Grade: '10' },
            { ID: 'G-32', Name: 'Step 32', Grade: '10' },
            { ID: 'G-33', Name: 'Step 33', Grade: '10' },
            { ID: 'G-34', Name: 'Step 34', Grade: '10' },
            { ID: 'G-35', Name: 'Step 35', Grade: '11' },
            { ID: 'G-36', Name: 'Step 36', Grade: '11' },
            { ID: 'G-37', Name: 'Step 37', Grade: '11' },
            { ID: 'G-38', Name: 'Step 38', Grade: '11' },
            { ID: 'G-39', Name: 'Step 39', Grade: '12' },
            { ID: 'G-40', Name: 'Step 40', Grade: '12' },
            { ID: 'G-41', Name: 'Step 41', Grade: '12' },
            { ID: 'G-42', Name: 'Step 42', Grade: '12' },
            { ID: 'G-43', Name: 'Step 43', Grade: '12' },
            { ID: 'G-44', Name: 'Step 44', Grade: '12' },
            { ID: 'G-45', Name: 'Step 45', Grade: '12' },
            { ID: 'G-46', Name: 'Step 46', Grade: '12' },
            { ID: 'G-47', Name: 'Step 47', Grade: '12' },
            { ID: 'G-48', Name: 'Step 48', Grade: '12' },
            { ID: 'G-49', Name: 'Step 49', Grade: '12' },
            { ID: 'G-50', Name: 'Step 50', Grade: '12' },
            { ID: 'G-51', Name: 'Step 51', Grade: '12' },
            { ID: 'G-52', Name: 'Step 52', Grade: '12' },
            { ID: 'G-53', Name: 'Step 53', Grade: '12' },
            { ID: 'G-54', Name: 'Step 54', Grade: '12' },
            { ID: 'G-55', Name: 'Step 55', Grade: '12' },
            { ID: 'G-56', Name: 'Step 56', Grade: '12' },
            { ID: 'G-57', Name: 'Step 57', Grade: '12' },
            { ID: 'G-58', Name: 'Step 58', Grade: '12' },
            { ID: 'G-59', Name: 'Step 59', Grade: '12' },
            { ID: 'G-60', Name: 'Step 60', Grade: '12' },
            { ID: 'G-61', Name: 'Step 61', Grade: '12' },
            { ID: 'G-62', Name: 'Step 62', Grade: '12' },
            { ID: 'G-63', Name: 'Step 63', Grade: '12' },
            { ID: 'G-64', Name: 'Step 64', Grade: '12' },
            { ID: 'G-65', Name: 'Step 65', Grade: '12' },
            { ID: 'G-66', Name: 'Step 66', Grade: '12' },
            { ID: 'G-67', Name: 'Step 67', Grade: '12' }
        ];

        /**
         * Checks if a Google Sheets "Publish to the web" URL needs the CSV output suffix 
         * and appends it if necessary.
         */
        function sanitizeUrl(url) {
            let normalizedUrl = url;

            if (normalizedUrl.includes('/pubhtml')) {
                normalizedUrl = normalizedUrl.replace('/pubhtml', '/pub');
            }

            if (normalizedUrl.includes('output=csv')) {
                return normalizedUrl;
            }

            const separator = normalizedUrl.includes('?') ? '&' : '?';
            
            // Append mandatory parameters for robust CSV export. 
            return normalizedUrl + separator + 'gid=0&single=true&output=csv';
        }
        
        // Helper function to update the status message area
        function setStatus(message, isError = false) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = isError 
                ? 'text-sm font-semibold text-red-600 mt-2' 
                : 'text-sm text-gray-600 mt-2';
        }

        // Display instruction text inside the SVG area
        function showInitialPrompt() {
            // Remove any previous error/prompt text
            svg.selectAll(".prompt-text").remove(); 
            svg.selectAll(".coverage-cell").remove();
            svg.selectAll(".x-axis").remove();

            svg.append("text")
                .attr("class", "prompt-text")
                .attr("x", currentChartWidth / 2) 
                .attr("y", 150)
                .attr("text-anchor", "middle")
                .style("font-size", "18px")
                .style("fill", "#6B7280") // Gray text
                .text("Paste your Google Sheet 'Publish to the web' link above and click 'Load Data'.");
            
            setStatus("Please provide the Program Coverage URL to visualize data.", true);
        }


        // --- 1. CORE LOGIC: DATA LOADING AND DRAWING ---

        function loadDataAndDrawChart(programUrl) {
            
            // Check for valid URL and display prompt if empty
            if (!programUrl) {
                showInitialPrompt(); 
                return;
            }
            
            setStatus("Sanitizing URL and loading program coverage data...", false);

            const sanitizedUrl = sanitizeUrl(programUrl);
            console.log("Sanitized URL for D3.csv:", sanitizedUrl); 
            
            // Clear previous chart elements before drawing the new one
            // We keep the Y-Axis element (y-axis) which is drawn in setupApp
            svg.selectAll(".prompt-text").remove();
            svg.selectAll(".coverage-cell").remove();
            svg.selectAll(".x-axis").remove();
            
            // Only load the program data
            d3.csv(sanitizedUrl).then(programData => {
                
                console.log("--- DEBUG START (Steps to Success Visualization) ---");
                
                // Check if program data loaded successfully 
                if (!programData || programData.length === 0) {
                    const msg = "Failed to load program data or data is empty. Ensure your Google Sheet is published and the URL is correct.";
                    console.error(msg);
                    setStatus(`Error: ${msg}`, true);
                    // Display error in the chart area as well
                    svg.append("text")
                        .attr("class", "prompt-text")
                        .attr("x", currentChartWidth / 2) 
                        .attr("y", 150)
                        .attr("text-anchor", "middle")
                        .style("font-size", "16px")
                        .style("fill", "#c0392b")
                        .text("Data loading failed. See Status message for details.");
                    return;
                }
                
                // IMPORTANT VALIDATION: Check for expected headers in the program data
                const expectedHeaders = ["Program_Name", "Goals_Covered", "Rigor", "Program_Type"];
                const actualHeaders = Object.keys(programData[0] || {});
                const missingHeaders = expectedHeaders.filter(header => !actualHeaders.includes(header));

                if (missingHeaders.length > 0) {
                    const msg = `Data loaded, but essential columns are missing: ${missingHeaders.join(', ')}. Check your spreadsheet headers.`;
                    console.error(msg, "Expected:", expectedHeaders, "Got:", actualHeaders);
                    setStatus(`Critical Error: ${msg}`, true);
                     svg.append("text")
                        .attr("class", "prompt-text")
                        .attr("x", currentChartWidth / 2) 
                        .attr("y", 150)
                        .attr("text-anchor", "middle")
                        .style("font-size", "16px")
                        .style("fill", "#c0392b")
                        .text("Data column names incorrect. Check Status message.");
                    return;
                }

                setStatus("Data loaded successfully. Drawing visualization...", false);
                
                // 2. Setup the dynamic X-Axis Selector and trigger the initial chart draw
                setupCategorySelector(programData);

            }).catch(error => {
                const msg = "An error occurred during program data loading. Check your network connection and the published URL format.";
                console.error(msg, error);
                setStatus(`Error: ${msg}`, true);
                // Display a generic error on the SVG too
                svg.append("text")
                   .attr("class", "prompt-text")
                   .attr("x", currentChartWidth / 2) 
                   .attr("y", 150)
                   .attr("text-anchor", "middle")
                   .style("font-size", "16px")
                   .style("fill", "#c0392b")
                   .text("Data loading failed. See Status message for details.");
            });
        }

        // Y-Axis (Goals) Setup
        function setupYAxis(frameworkData) {
            const goalIDs = frameworkData.map(d => d.ID); 
            
            // Calculate dynamic height based on number of goals
            const stepHeight = 18; 
            const dynamicHeight = goalIDs.length * stepHeight; 
            // Set height of the SVG container
            svgContainer.attr("height", dynamicHeight + margin.top + margin.bottom);
            svgContainer.attr("width", currentChartWidth + margin.left + margin.right);
            
            yScale = d3.scaleBand()
                .domain(goalIDs) 
                .range([0, dynamicHeight])
                .paddingInner(0.1); 

            // Draw the Y-axis 
            svg.selectAll(".y-axis").remove();
            svg.append("g")
                .attr("class", "y-axis")
                // Use the Name property from the framework data for the tick label
                .call(d3.axisLeft(yScale).tickFormat(d => frameworkData.find(g => g.ID === d)?.Name || d)) 
                .selectAll("text")
                .attr("dy", ".32em")
                .style("text-anchor", "end");
        }

        // Category Selector Setup
        function setupCategorySelector(programData) {
            const selector = d3.select("#categorySelector");
            
            // Clear existing options
            selector.selectAll("option").remove();

            selector.selectAll("option")
                .data(categoryOptions)
                .enter()
                .append("option")
                .text(d => d.replace(/_/g, ' '))
                .attr("value", d => d);

            // Draw the chart with the first category as default
            drawChart(categoryOptions[0], programData); 

            // Listener for change 
            selector.on("change", function() {
                const newCategory = d3.select(this).property("value");
                drawChart(newCategory, programData);
            });
        }

        // --- 2. CHART LOGIC: AGGREGATION AND DRAWING ---

        function getColor(programCount) {
            if (programCount >= 2) {
                return "#c0392b"; // Red for Overlap
            } else if (programCount === 1) {
                return "#3498db"; // Blue for Coverage
            } else {
                return "#f0f0f0"; // Light Gray for No Coverage
            }
        }

        function drawChart(categoryKey, allProgramData) {
            // Clear any previous drawing elements (except the Y-Axis)
            svg.selectAll(".coverage-cell").remove();
            svg.selectAll(".x-axis").remove();
            svg.selectAll(".prompt-text").remove();
            setStatus("Drawing visualization...", false);

            // A. Data Aggregation
            const nestedData = d3.group(allProgramData, d => d[categoryKey]);
            const cellData = [];

            for (const [categoryValue, programsInGroup] of nestedData) {
                let goalProgramsMap = new Map(); 

                programsInGroup.forEach(program => {
                    // Split the Goals_Covered string
                    const goalsCoveredArray = program.Goals_Covered ? program.Goals_Covered.split(',').map(g => g.trim()) : [];
                    
                    goalsCoveredArray.forEach(goalId => {
                        if (!goalId) return; 
                        
                        const currentPrograms = goalProgramsMap.get(goalId) || [];
                        if (program.Program_Name) {
                            currentPrograms.push(program.Program_Name); 
                        }
                        goalProgramsMap.set(goalId, currentPrograms);
                    });
                });

                for (const [goalId, programNames] of goalProgramsMap) {
                    if (yScale.domain().includes(goalId)) { 
                        cellData.push({
                            goalId: goalId,
                            category: categoryValue,
                            programCount: programNames.length,
                            programNames: programNames 
                        });
                    }
                }
            }
            
            // B. X-Axis Setup
            const categoryDomains = Array.from(new Set(allProgramData.map(d => d[categoryKey]))).filter(d => d).sort();

            // Calculate Dynamic Width based on categories
            currentChartWidth = Math.max(initialWidth, categoryDomains.length * MIN_CATEGORY_WIDTH);

            if (categoryDomains.length === 0) {
                const msg = `Critical Error: Cannot find any unique values in the '${categoryKey.replace(/_/g, ' ')}' column. Please verify the header name in your published Sheet 2.`;
                setStatus(msg, true);
                console.error(msg);
                
                svg.append("text")
                   .attr("class", "prompt-text")
                   .attr("x", initialWidth / 2) 
                   .attr("y", 150)
                   .attr("text-anchor", "middle")
                   .style("font-size", "16px")
                   .style("fill", "#c0392b")
                   .text("Drawing failed. Check the category column header.");
                return; 
            }
            
            // Update SVG container width dynamically.
            svgContainer.attr("width", currentChartWidth + margin.left + margin.right);

            const xScale = d3.scaleBand()
                .domain(categoryDomains)
                .range([0, currentChartWidth]) // Use the dynamic width
                .paddingInner(0.1);

            // Redraw X-Axis
            svg.append("g")
                .attr("class", "x-axis")
                .call(d3.axisTop(xScale)) 
                .selectAll("text")
                .style("text-anchor", "middle")
                .attr("dx", "0em")
                .attr("dy", "-.5em")
                .attr("transform", "rotate(0)");

            // C. Drawing Cells (Rectangles)
            const cells = svg.selectAll(".coverage-cell")
                .data(cellData, d => d.goalId + d.category);

            cells.exit().remove();

            cells.enter()
                .append("rect")
                .attr("class", "coverage-cell")
                .merge(cells) 
                .attr("x", d => xScale(d.category))
                .attr("y", d => yScale(d.goalId))
                .attr("width", xScale.bandwidth())
                .attr("height", yScale.bandwidth())
                .attr("fill", d => getColor(d.programCount))
                
                // --- Tooltip Interactivity ---
                .on("mouseover", function(event, d) {
                    tooltip.style("visibility", "visible");
                    d3.select(this).attr("stroke", "#2c3e50").attr("stroke-width", 2);
                })
                .on("mousemove", function(event, d) {
                    // Find the Step Name for the tooltip using the global framework data
                    const goalName = allFrameworkData.find(g => g.ID === d.goalId)?.Name || d.goalId;

                    tooltip.style("left", (event.pageX + 10) + "px")     
                           .style("top", (event.pageY - 20) + "px")
                           .html(`
                               <strong>Goal:</strong> ${goalName}<br>
                               <strong>Category:</strong> ${d.category}<br>
                               <strong>Programs:</strong> ${d.programNames.join(", ")}<br>
                               ${d.programCount >= 2 ? `<strong>Overlap: ${d.programCount} programs</strong>` : 'Coverage'}
                           `);
                })
                .on("mouseout", function() {
                    tooltip.style("visibility", "hidden");
                    d3.select(this).attr("stroke", "none");
                });
            
            if (cellData.length > 0) {
                 setStatus("Visualization ready.", false);
            } else {
                 setStatus("Warning: Data loaded, but no covered goals were found. Check the 'Goals_Covered' column in your sheet.", true);
            }
        }

        // --- 3. APP SETUP ---

        function setupApp() {
            const loadButton = document.getElementById('loadDataButton');
            const programInput = document.getElementById('programUrlInput');

            // 1. Set up Y-Axis and Framework Data immediately for structural visibility
            allFrameworkData = hardcodedFrameworkData; 
            setupYAxis(hardcodedFrameworkData);
            
            // 2. Display the initial instruction prompt
            showInitialPrompt();

            // 3. Attach event listener to the "Load Data" button
            loadButton.addEventListener('click', () => {
                const prgUrl = programInput.value.trim();
                loadDataAndDrawChart(prgUrl);
            });
        }

        // Start the application setup
        setupApp();
    </script>
</body>
</html>
